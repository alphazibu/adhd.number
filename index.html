<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Focus Density</title>
<style>
:root{--m:#7cfbff}body{margin:0;height:100vh;overflow:hidden;display:flex;justify-content:center;align-items:center;background:#020808;color:#fff;font-family:system-ui}#b{position:absolute;inset:0;filter:blur(160px);z-index:-3;transition:2s}canvas{position:absolute;inset:0;z-index:-2}.c{width:340px;text-align:center;position:relative}.cnt{font-size:9rem;font-weight:100;line-height:1}.g{text-shadow:0 0 35px var(--m);color:#fff}.l{margin-top:10px;font-size:1.4rem;font-weight:200;opacity:.6;letter-spacing:2px}.r{margin-top:40px;opacity:.3;font-size:.9rem;letter-spacing:1px}.p{font-size:1.8rem;color:var(--m);position:absolute;left:50%;bottom:0;transform:translateX(-50%);opacity:0;pointer-events:none;font-weight:bold}
</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-M1S3L1RBG4"></script>
<script>
  window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-M1S3L1RBG4');
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.onkeydown = e => { if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || (e.ctrlKey && e.keyCode === 85)) return false; };
  setInterval(() => { const s = performance.now(); debugger; if (performance.now() - s > 50) window.location.reload(); }, 500);
</script>
</head>
<body>
<div id="b"></div><canvas id="v"></canvas>
<div class="c">
<div class="cnt" id="x1">0</div>
<div class="l" id="x2">- / -</div>
<div class="r" id="x3">×1</div>
<div class="p" id="x4"></div>
</div>

<script type="module">
import{initializeApp as _a}from"https://www.gstatic.com/firebasejs/10.2.0/firebase-app.js";
import{getDatabase as _b,ref as _c,set as _d,onValue as _e,get as _g}from"https://www.gstatic.com/firebasejs/10.2.0/firebase-database.js";

const _conf={apiKey:"AIzaSyAYH1Toi-3rGehVEUiF1bg-7XKwEeysXps",authDomain:"adhd-timer-f5d96.firebaseapp.com",databaseURL:"https://adhd-timer-f5d96-default-rtdb.firebaseio.com",projectId:"adhd-timer-f5d96",storageBucket:"adhd-timer-f5d96.firebasestorage.app",messagingSenderId:"172916262460",appId:"1:172916262460:web:c87ffd8e29a54dc18d6539"};
const _db=_b(_a(_conf)),_D=document,_X1=_D.getElementById('x1'),_X2=_D.getElementById('x2'),_X3=_D.getElementById('x3'),_X4=_D.getElementById('x4'),_B=_D.getElementById('b');

let _s=JSON.parse(localStorage.getItem('fd_l'))||{c:0,m:1},_id=localStorage.getItem('ui')||'u'+Math.random().toString(36).substr(2,5);
localStorage.setItem('ui',_id);

const _ani=(_v)=>{_X4.textContent='+'+Math.floor(_v);_X4.style.opacity=1;let s=performance.now();requestAnimationFrame(function f(t){let e=(t-s)/800;if(e>1){_X4.style.opacity=0;return}_X4.style.transform=`translateX(-50%) translateY(${-60*e}px)`;_X4.style.opacity=1-e;requestAnimationFrame(f)})};

const _th=()=>{
  const h=new Date().getHours(),t=h<6?["#7b5cff","#2b145c"]:h<12?["#7cfbff","#a0f0ff"]:h<18?["#5effc6","#7cffd6"]:["#ffb86c","#ff8c42"];
  _D.documentElement.style.setProperty("--m",t[0]);
  _B.style.background=`radial-gradient(circle,${t[1]},#000)`;
};
_th();setInterval(_th,6e4);

let _act=1,_lt=performance.now();
_D.addEventListener('visibilitychange',()=>_act=!_D.hidden);

const _sv=()=>_d(_c(_db,'scores/'+_id),{
  m:_s.m, c:Math.floor(_s.c), s:((_s.m-1)*10000)+Math.floor(_s.c), i:_id, t:Date.now()
});

// --- ランキング表示: 並び替えエラーを回避する手動ソート方式 ---
_e(_c(_db,'scores/'), k=>{
  if(!k.exists()) return;
  let a=[];
  k.forEach(x=>{
    let d=x.val();
    // 通算スコアsがない古いデータを計算で救済
    let score = (d.s !== undefined) ? d.s : (((d.m||1)-1)*10000) + (d.c||0);
    a.push({i:x.key, s:score});
  });
  // スコアの大きい順に並び替え
  a.sort((p,q)=>q.s - p.s);
  const rank = a.findIndex(z=>z.i===_id)+1;
  _X2.textContent = rank > 0 ? (rank + ' / ' + a.length) : ('- / ' + a.length);
});

setInterval(_sv,5000);

(function _tick(t){
  const dt=(t-_lt)/1000;_lt=t;
  if(_act){
    _s.c+=dt;
    if(_s.c>=1e4){ _s.c-=1e4; _s.m++; _X1.classList.add('g'); setTimeout(()=>_X1.classList.remove('g'),500); }
    _X1.textContent=Math.floor(_s.c).toLocaleString();
    _X3.textContent='×'+_s.m;
  }
  localStorage.setItem('fd_l',JSON.stringify(_s));
  requestAnimationFrame(_tick);
})(performance.now());

// デザイン：パーティクル背景
const _cv=_D.getElementById('v'),_ct=_cv.getContext('2d');
const _res=()=>{_cv.width=innerWidth;_cv.height=innerHeight;};
window.onresize=_res;_res();
let _ps=[...Array(180)].map(()=>({x:Math.random()*_cv.width,y:Math.random()*_cv.height,a:Math.random()-.5,b:Math.random()-.5,s:Math.random()}));
(function _lp(){
  _ct.clearRect(0,0,_cv.width,_cv.height);
  _ps.forEach(p=>{
    p.x+=p.a*0.3;p.y+=p.b*0.3;
    if(p.x<0)p.x=_cv.width;if(p.x>_cv.width)p.x=0;
    if(p.y<0)p.y=_cv.height;if(p.y>_cv.height)p.y=0;
    _ct.fillStyle=`rgba(255,255,255,${p.s})`;
    _ct.beginPath();_ct.arc(p.x,p.y,1.5,0,6.28);_ct.fill()
  });
  requestAnimationFrame(_lp)
})();
</script>
</body>
</html>
