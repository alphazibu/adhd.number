<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Focus Density</title>
<style>
:root{--main:#7cfbff;--sub:#00e5ff;}
body{
  margin:0;height:100vh;overflow:hidden;
  display:flex;justify-content:center;align-items:center;
  background:#020808;color:#fff;font-family:system-ui;
}
#bg{position:absolute;inset:0;filter:blur(160px);z-index:-3;transition:2s}
canvas{position:absolute;inset:0;z-index:-2}
.card{
  width:340px;text-align:center;background:none;border:none;position:relative;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
}
.count{
  font-size:9rem;font-weight:100;line-height:1;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.glow{text-shadow:0 0 35px var(--main);color:#fff;}
.leaderboard{
  margin-top:10px;font-size:1.4rem;font-weight:200;opacity:0.6;letter-spacing:2px;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;
}
.rank{
  margin-top:40px;opacity:.9;font-size:2rem;font-weight:600;
  letter-spacing:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
  width:100%;text-align:center;
  position:relative; /* これで中央に固定 */
}
.increase-msg{
  font-size:1.5rem;color:#7cfbff;position:absolute;left:50%;bottom:0;transform:translateX(-50%) translateY(0);
  opacity:0; pointer-events:none;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
</style>
</head>
<body>
<div id="bg"></div>
<canvas id="c"></canvas>

<div class="card" id="card">
  <div class="count" id="count">0</div>
  <div class="leaderboard" id="rank-display">- / -</div>
  <div class="rank" id="rank">×1</div>
  <div class="increase-msg" id="increase-msg"></div>
</div>

<script type="module">
// --- Firebase 初期化 ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAYH1Toi-3rGehVEUiF1bg-7XKwEeysXps",
  authDomain: "adhd-timer-f5d96.firebaseapp.com",
  databaseURL: "https://adhd-timer-f5d96-default-rtdb.firebaseio.com",
  projectId: "adhd-timer-f5d96",
  storageBucket: "adhd-timer-f5d96.firebasestorage.app",
  messagingSenderId: "172916262460",
  appId: "1:172916262460:web:c87ffd8e29a54dc18d6539",
  measurementId: "G-M1S3L1RBG4"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- ユーザーデータ ---
const KEY="fd_global";
let st=JSON.parse(localStorage.getItem(KEY))||{count:0,name:"User"+Math.floor(Math.random()*1000)};
if(!localStorage.getItem("fd_name")){
  let n = prompt("Enter your name", st.name);
  if(n){ st.name=n; localStorage.setItem("fd_name", n); }
}else{ st.name = localStorage.getItem("fd_name"); }

// --- UID作成（同名ユーザー対策） ---
if(!localStorage.getItem("fd_uid")){
  localStorage.setItem("fd_uid", 'u' + Math.floor(Math.random()*1000000));
}
const uid = localStorage.getItem("fd_uid");

const save=()=>localStorage.setItem(KEY, JSON.stringify(st));
const countEl = document.getElementById('count');
const rankEl = document.getElementById('rank');
const msgEl = document.getElementById('increase-msg');
const leaderboardEl = document.getElementById('rank-display');

function ui(mult, glow=false){
  countEl.textContent = Math.floor(st.count).toLocaleString();
  rankEl.textContent = "×"+mult; // 常に倍率表示
  // 真ん中に固定されるようCSSで調整済
  if(glow){
    countEl.classList.add('glow');
    setTimeout(()=>countEl.classList.remove('glow'),300);
  }
}

// 「+増分」をふわっとバウンド付きで表示
function animateIncrease(amount){
  if(amount <=0) return;
  msgEl.style.opacity = 1;
  msgEl.style.transform = `translateX(-50%) translateY(0)`;
  msgEl.textContent = "+" + amount.toLocaleString();
  
  const duration = 1000;
  const start = performance.now();

  function step(time){
    let t = (time - start)/duration;
    if(t>1) t=1;
    let bounce = -40*t + 10*Math.sin(t*3.14); 
    msgEl.style.transform = `translateX(-50%) translateY(${bounce}px)`;
    msgEl.style.opacity = String(1 - t);
    if(t < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// 背景テーマ
function theme(){
  const h = new Date().getHours();
  const t = h<6?["#7b5cff","#2b145c"]:h<12?["#7cfbff","#a0f0ff"]:h<18?["#5effc6","#7cffd6"]:["#ffb86c","#ff8c42"];
  document.documentElement.style.setProperty("--main", t[0]);
  document.getElementById('bg').style.background = `radial-gradient(circle, ${t[1]}, #000)`;
}
theme(); setInterval(theme,60000);

// 粒子アニメ
const c = document.getElementById('c');
const ctx = c.getContext("2d");
c.width = innerWidth; c.height = innerHeight;
let ps = [...Array(180)].map(()=>({
  x:Math.random()*c.width,
  y:Math.random()*c.height,
  vx:(Math.random()-.5)*0.3,
  vy:(Math.random()-.5)*0.3,
  a:Math.random()
}));
(function loop(){
  ctx.clearRect(0,0,c.width,c.height);
  ps.forEach(p=>{
    p.x+=p.vx; p.y+=p.vy;
    if(p.x<0||p.x>c.width)p.vx*=-1;
    if(p.y<0||p.y>c.height)p.vy*=-1;
    ctx.fillStyle=`rgba(255,255,255,${p.a})`;
    ctx.beginPath(); ctx.arc(p.x,p.y,2,0,6.28); ctx.fill();
  });
  requestAnimationFrame(loop);
})();

// タブ管理
let isActive=true, inactiveStart=Date.now();
document.addEventListener("visibilitychange", ()=>{
  if(document.hidden){
    isActive=false;
    inactiveStart = Date.now();
  } else {
    isActive=true;
    const elapsed = (Date.now() - inactiveStart)/1000;
    const stepMulti = Math.floor(st.count/10000)+1;
    const gained = Math.floor(elapsed*2*stepMulti);
    if(gained>0) animateIncrease(gained);
    st.count += gained;
  }
});

// --- Firebase 保存＆ランキング ---
function saveScore() {
  set(ref(db, 'scores/' + uid), {
    count: Math.floor(st.count),
    name: st.name
  });
}

function updateRanking() {
  const scoresRef = ref(db, 'scores/');
  onValue(scoresRef, (snapshot) => {
    let arr = [];
    snapshot.forEach(child => arr.push(child.val()));
    arr.sort((a,b)=>b.count - a.count);
    let rank = arr.findIndex(u => u.name === st.name) + 1;
    let total = arr.length;
    leaderboardEl.textContent = `${rank} / ${total}`;
  });
}

// 最初に呼ぶ
updateRanking();

// カウント更新ループ
let last = Date.now();
setInterval(()=>{
  const now = Date.now();
  let elapsed = (now-last)/1000;
  last = now;

  let speed = 1;
  let glow = false;
  if(!isActive){ speed = 2; glow = true; }

  const stepMulti = Math.floor(st.count/10000)+1;
  st.count += elapsed * speed * stepMulti;
  save();
  saveScore();     // Firebaseに保存
  ui(stepMulti, glow); // 倍率表示
  updateRanking();   // ランキング更新
},50);

</script>
</body>
</html>
