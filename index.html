<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Focus Density</title>

<style>
:root{--main:#7cfbff;}
body{
  margin:0;height:100vh;overflow:hidden;
  display:flex;justify-content:center;align-items:center;
  background:#020808;color:#fff;font-family:system-ui;
}
#bg{position:absolute;inset:0;filter:blur(160px);z-index:-3}
canvas{position:absolute;inset:0;z-index:-2}

.card{text-align:center;position:relative}
.count{font-size:9rem;font-weight:100}
.leaderboard{opacity:.6;margin-top:6px}
.rank{font-size:2rem;margin-top:24px}
.increase{
  position:absolute;bottom:20px;
  font-size:1.5rem;
  opacity:0;
  transition:.8s;
}
</style>
</head>

<body>
<div id="bg"></div>
<canvas id="c"></canvas>

<div class="card">
  <div class="count" id="count">0</div>
  <div class="leaderboard" id="lb">- / -</div>
  <div class="rank" id="multi">×1</div>
  <div class="increase" id="inc"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-database.js";

const app = initializeApp({
  apiKey:"AIzaSyAYH1Toi-3rGehVEUiF1bg-7XKwEeysXps",
  databaseURL:"https://adhd-timer-f5d96-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);

// UID
if(!localStorage.uid) localStorage.uid="u"+Math.random().toString(36).slice(2);
const uid=localStorage.uid;

// 状態
let countVal=0;
let last=Date.now();

// Firebase復元（最優先）
const snap = await get(ref(db,"scores/"+uid));
if(snap.exists()) countVal = snap.val().count || 0;

// UI
const ce=count, lbE=lb, me=multi, incE=inc;

// 非表示中カウント
let hiddenAt=0;
document.addEventListener("visibilitychange",()=>{
  if(document.hidden) hiddenAt=Date.now();
  else{
    const g=Math.floor((Date.now()-hiddenAt)/1000)*2;
    if(g>0){
      countVal+=g;
      incE.textContent="+"+g;
      incE.style.opacity=1;
      incE.style.transform="translateY(-30px)";
      setTimeout(()=>incE.style.opacity=0,800);
    }
  }
});

// メインループ（光らない）
setInterval(()=>{
  const now=Date.now();
  const dt=(now-last)/1000; last=now;
  const m=Math.floor(countVal/10000)+1;
  countVal+=dt*m;

  ce.textContent=Math.floor(countVal).toLocaleString();
  me.textContent="×"+m;

  set(ref(db,"scores/"+uid),{
    count:Math.floor(countVal),
    t:Date.now()
  });
},100);

// リアルタイムランキング
onValue(ref(db,"scores"),s=>{
  let a=[];
  s.forEach(c=>a.push(c.val()));
  a.sort((x,y)=>y.count-x.count);
  const r=a.findIndex(v=>v.count===Math.floor(countVal))+1;
  lbE.textContent=`${r} / ${a.length}`;
});

// 背景
function theme(){
  const h=new Date().getHours();
  const c=h<6?["#7b5cff","#2b145c"]:
          h<18?["#7cfbff","#5effc6"]:
               ["#ffb86c","#ff8c42"];
  document.documentElement.style.setProperty("--main",c[0]);
  bg.style.background=`radial-gradient(circle,${c[1]},#000)`;
}
theme(); setInterval(theme,60000);

// canvas
const cv=c, ctx=cv.getContext("2d");
function resize(){
  cv.width=innerWidth;
  cv.height=innerHeight;
}
window.addEventListener("resize",resize);
resize();

// 粒子（静か）
let p=[...Array(120)].map(()=>({
  x:Math.random()*cv.width,
  y:Math.random()*cv.height,
  vx:(Math.random()-.5)*.25,
  vy:(Math.random()-.5)*.25
}));
(function loop(){
  ctx.clearRect(0,0,cv.width,cv.height);
  p.forEach(o=>{
    o.x+=o.vx; o.y+=o.vy;
    if(o.x<0||o.x>cv.width)o.vx*=-1;
    if(o.y<0||o.y>cv.height)o.vy*=-1;
    ctx.fillStyle="rgba(255,255,255,.4)";
    ctx.fillRect(o.x,o.y,2,2);
  });
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
